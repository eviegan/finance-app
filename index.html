<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>My Money – Simple Budget App</title>
<meta name="theme-color" content="#0b0f1f" />
<link rel="preconnect" href="https:\/\/fonts.googleapis.com">
<link rel="preconnect" href="https:\/\/fonts.gstatic.com" crossorigin>
<link href="https:\/\/fonts.googleapis.com\/css2?family=Baloo+2:wght@400..800&family=Nunito:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    /* Brighter, cartoon palette */
    --bg:#0b0f1f; --panel:#0f1330; --ink:#fff8fd; --mut:#ffe2f4; --ring:#2a2f66;
    --g1:#ff9bd4; --g2:#8a7bff; --a1:#7af9ff; --ok:#b5ff7d; --bad:#ff8aa1;
    --shadow:0 14px 40px rgba(0,0,0,.40), 0 0 0 3px rgba(255,155,212,.08);
    --pop: drop-shadow(0 8px 0 rgba(0,0,0,.25));
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    background:
      radial-gradient(1200px 800px at 70% -10%, #2a3a88 0%, #1b224b 50%, #0b0f1f 100%),
      linear-gradient(135deg, rgba(255,155,212,.12), rgba(138,123,255,.12));
    font-family: 'Baloo 2', Nunito, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    line-height:1.35;
    overflow-x:hidden;
  }
  /* floating doodles */
  body::before, body::after{
    content:""; position:fixed; inset:auto; z-index:0; pointer-events:none; opacity:.5;
    width:320px; height:320px; border-radius:50%; filter:blur(50px);
    background:radial-gradient(circle at 30% 30%, rgba(255,207,98,.75), transparent 60%);
    animation: float1 12s ease-in-out infinite;
  }
  body::after{ left:auto; right:-120px; bottom:-80px; background:radial-gradient(circle at 70% 70%, rgba(122,249,255,.75), transparent 60%); animation: float2 14s ease-in-out infinite;}
  @keyframes float1{ 0%,100%{transform:translate(-60px,0)} 50%{transform:translate(0,20px)} }
  @keyframes float2{ 0%,100%{transform:translate(60px,0)} 50%{transform:translate(0,-20px)} }

  .wrap{max-width:1100px;margin-inline:auto;padding:24px; position:relative; z-index:1}
  header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px}
  .title{display:flex;align-items:center;gap:12px}
  .logo{width:56px;height:56px;border-radius:16px;background:linear-gradient(135deg,var(--g1),var(--g2));
    display:grid;place-items:center;filter:var(--pop); box-shadow:var(--shadow); border:3px solid #ffffff22}
  .logo b{font-size:30px}
  h1{font-size:26px;margin:0; letter-spacing:.2px; text-shadow:0 2px 0 #00000055}
  .mut{color:#ffe4ff; opacity:.9}
  .row{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:940px){.row{grid-template-columns: 1.1fr .9fr}}

  .card{background:linear-gradient(180deg, rgba(19,24,64,.95), rgba(15,19,48,.95)); border:3px solid #2f368f; border-radius:20px; padding:18px; box-shadow:var(--shadow)}
  .card h2{font-size:18px;margin:0 0 12px}

  .grid-2{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:680px){.grid-2{grid-template-columns:1fr 1fr}}

  label{display:block;font-size:13px;color:#ffe6ff;margin:2px 0 6px}
  input[type="number"], input[type="text"], select{width:100%;padding:14px 14px;border-radius:14px;border:3px solid #3b44b3;background:#171d52;color:var(--ink); box-shadow:inset 0 -4px 0 #0a0f3a}
  input[type="number"]{appearance:textfield}
  input[type="number"]::-webkit-outer-spin-button,
  input[type="number"]::-webkit-inner-spin-button{appearance:none;margin:0}
  input:focus{outline:none; border-color:#ffb3e5; box-shadow:0 0 0 4px #ffb3e522, inset 0 -4px 0 #0a0f3a; transform:translateY(-1px) rotate(-.2deg)}

  .btn{display:inline-flex;gap:8px;align-items:center;justify-content:center;padding:12px 16px;border-radius:16px;border:3px solid #3740b0;background:#1b2160;color:var(--ink);cursor:pointer;text-decoration:none; transition:.15s transform ease, .15s filter ease; filter:var(--pop)}
  .btn:hover{transform:translateY(-2px)}
  .btn:active{transform:translateY(0) scale(.98)}
  .btn.primary{background:linear-gradient(90deg,var(--g1),var(--g2)); border-color:#ffffff00}
  .btn.ghost{background:#141a4b}
  .right{margin-left:auto}

  .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{padding:6px 12px;border-radius:999px;border:3px solid #3b44b3;background:#171d52;color:var(--ink);font-size:13px}

  .list{display:grid;gap:10px;margin-top:8px}
  .item{display:grid;grid-template-columns:160px 1fr 220px 40px;gap:8px;align-items:center}
  .item input[type="text"]{background:#161d4e}
  .item input[type="number"]{text-align:right; font-size:18px; letter-spacing:.3px; font-variant-numeric: tabular-nums}
  .item .del{background:#212a78;border:3px solid #3a4aa0;border-radius:12px;display:grid;place-items:center;cursor:pointer;height:46px;font-size:16px; transition:.15s transform ease}
  .item .del:hover{transform:rotate(-8deg)}
  .addline{margin-top:10px}

  .summary{display:grid;gap:12px}
  .summary .srow{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-radius:14px;background:#151a4a;border:3px solid #3740b0}
  .summary .srow strong{font-weight:800}
  .summary .accent{background:linear-gradient(90deg, rgba(255,110,196,.25), rgba(120,115,245,.20)); border-color:#7146ff}
  .summary .good{border-color:#3a7c3a;background:linear-gradient(90deg, rgba(181,255,125,.22), rgba(120,245,190,.10));}
  .summary .warn{border-color:#963a55;background:linear-gradient(90deg, rgba(255,138,161,.26), rgba(245,120,120,.12));}

  .footer-actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px}
  .note{font-size:12px;color:#ffe4ff}

  .tabs{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
  .tab{padding:10px 12px;border-radius:12px;border:3px solid #3b44b3;background:#161d4e;cursor:pointer; font-weight:700}
  .tab.active{background:linear-gradient(90deg,var(--g1),var(--g2));border-color:transparent}

  details{border:3px solid #3b44b3;border-radius:14px;padding:10px;background:#151b52}
  details>summary{cursor:pointer;list-style:none}
  details>summary::-webkit-details-marker{display:none}

  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px; background:#12174a; padding:2px 6px; border-radius:6px; border:2px solid #2a386a}
  /* mobile layout tweaks */
  @media(max-width:700px){
    .item{grid-template-columns:120px 1fr 170px 36px}
    .item input[type="text"], .item select{font-size:16px}
    .item input[type="number"]{font-size:18px}
  }
  /* animated button squish */
  .btn{animation:squish 3s ease-in-out infinite alternate}
  @keyframes squish{0%{transform:translateY(0) scale(1)}100%{transform:translateY(-1px) scale(1.02)}}
  /* BG layer + themes */
  .bg-layer{position:fixed; inset:0; overflow:hidden; z-index:0; pointer-events:none}
  .bg-layer.off{display:none}
  .bg{position:absolute; opacity:.55; transform:translateZ(0)}
  .cloud{width:360px;height:220px;border-radius:120px;background:radial-gradient(circle at 30% 40%, #fff4, #fff1 60%); filter:blur(2px)}
  .cloud-1{left:-80px; top:40px; animation: drift 26s linear infinite}
  .cloud-2{right:-100px; top:140px; animation: drift 30s linear infinite reverse}
  .coin{font-size:54px; text-shadow:0 8px 0 #0006;}
  .coin-1{left:10%; top:65%; animation: bob 5s ease-in-out infinite}
  .coin-2{right:12%; top:25%; animation: bob 7s ease-in-out infinite}
  .star{color:#fff8; font-size:22px}
  .star-1{left:20%; top:20%; animation: twinkle 3s ease-in-out infinite}
  .star-2{right:22%; top:70%; animation: twinkle 4s ease-in-out infinite .6s}
  @keyframes drift{0%{transform:translateX(0)}100%{transform:translateX(30vw)}}
  @keyframes bob{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
  @keyframes twinkle{0%,100%{opacity:.25}50%{opacity:.8}}

  body[data-theme="candy"]{background:
    radial-gradient(1200px 800px at 70% -10%, #ffb7e6 0%, #8a7bff 40%, #0b0f1f 100%),
    linear-gradient(135deg, rgba(255,200,0,.08), rgba(122,249,255,.10));}
  body[data-theme="money"]{background:
    radial-gradient(1200px 800px at 60% -10%, #5fffb4 0%, #3fa277 45%, #0b0f1f 100%),
    linear-gradient(135deg, rgba(255,255,255,.05), rgba(0,0,0,.15));}
  body[data-theme="galaxy"]{background:
    radial-gradient(1200px 800px at 50% -10%, #6ee7ff 0%, #7f5cff 40%, #0b0f1f 100%),
    linear-gradient(135deg, rgba(255,110,196,.12), rgba(120,115,245,.12));}
</style>
</head>
<body>
  <!-- Animated background layer -->
  <div class="bg-layer">
    <div class="bg cloud cloud-1"></div>
    <div class="bg cloud cloud-2"></div>
    <div class="bg coin coin-1">💰</div>
    <div class="bg coin coin-2">🪙</div>
    <div class="bg star star-1">✦</div>
    <div class="bg star star-2">✦</div>
  </div>
  <div class="wrap">
    <header>
      <div class="title">
        <div class="logo" aria-hidden="true"><b>💸</b></div>
        <div>
          <h1>My Money – Monthly Planner</h1>
          <div class="mut">Track salary, credit card, expenses & savings. Everything in one flow.</div>
        </div>
      </div>
      <div class="flex">
        <button class="btn ghost" id="btnExport" title="Export JSON">Export</button>
        <label class="btn ghost" for="importFile" title="Import JSON">Import<input id="importFile" type="file" accept="application/json" hidden></label>
        <button class="btn" id="btnReset" title="Clear this month">Clear</button>
      </div>
    </header>

    <div class="row">
      <section class="card">
        <div class="tabs" id="monthTabs"></div>
        <div class="grid-2">
          <div>
            <h2>1) Income 🧾</h2>
            <div class="list" id="incomeList"></div>
            <button class="btn addline" id="addIncome">+ Add income</button>
          </div>
          <div>
            <h2>2) Credit Card Bill 💳</h2>
            <label>Statement Amount</label>
            <input type="number" id="ccAmount" placeholder="e.g. 1200" min="0" step="0.01"/>
            <div class="flex" style="margin-top:8px">
              <label class="pill"><input type="radio" name="ccPay" value="full" checked> &nbsp;Pay in full</label>
              <label class="pill"><input type="radio" name="ccPay" value="min"> &nbsp;Pay minimum</label>
              <input type="number" id="ccMinPct" class="right" style="max-width:120px" value="5" min="1" max="50" step="1" />
            </div>
            <div class="note" style="margin-top:6px">Tip: Paying in full avoids interest. If paying minimum, we’ll reserve <span id="minReserve">0</span> now and carry the rest as debt (informational only).</div>
          </div>
        </div>

        <div class="grid-2" style="margin-top:14px">
          <div>
            <h2>3) Other Expenses</h2>
            <details open>
              <summary><strong>Fixed</strong> (rent, insurance, subscriptions) 🧱</summary>
              <div class="list" id="fixedList"></div>
              <button class="btn addline" id="addFixed">+ Add fixed</button>
            </details>
            <details style="margin-top:10px" open>
              <summary><strong>Variable</strong> (food, transport, fun) 🎈</summary>
              <div class="list" id="varList"></div>
              <button class="btn addline" id="addVar">+ Add variable</button>
            </details>
          </div>
          <div>
            <h2>4) Savings 🐷</h2>
            <div class="flex">
              <label class="pill"><input type="radio" name="saveMode" value="percent" checked> &nbsp;% of income</label>
              <label class="pill"><input type="radio" name="saveMode" value="amount"> &nbsp;Fixed amount</label>
            </div>
            <div class="grid-2" style="margin-top:8px">
              <div>
                <label>Percent</label>
                <input type="number" id="savePct" value="10" min="0" max="90" step="1"/>
              </div>
              <div>
                <label>Fixed Amount</label>
                <input type="number" id="saveAmt" value="0" min="0" step="0.01"/>
              </div>
            </div>

            <h2 style="margin-top:14px">5) Summary 🎉</h2>
            <div class="summary" id="summaryBox">
              <div class="srow accent"><span>Total Income</span><strong id="sumIncome">0</strong></div>
              <div class="srow"><span>Credit Card (this month)</span><strong id="sumCC">0</strong></div>
              <div class="srow"><span>Fixed Expenses</span><strong id="sumFixed">0</strong></div>
              <div class="srow"><span>Variable Budget</span><strong id="sumVar">0</strong></div>
              <div class="srow"><span>Savings</span><strong id="sumSave">0</strong></div>
              <div class="srow good"><span>Leftover (Free to Use)</span><strong id="sumLeft">0</strong></div>
              <div class="srow" id="perDayRow"><span>Safe per day (<span id="daysLeft">0</span> days left)</span><strong id="perDay">0</strong></div>
              <div class="srow warn" id="overspendRow" style="display:none"><span>Warning</span><strong>Overspending this month</strong></div>
            </div>
            <div class="footer-actions">
              <button class="btn primary" id="btnQuickAdd">Quick add: salary + card</button>
              <button class="btn" id="btnToday">Set month = current</button>
            </div>
            <div class="note">Save/Load happens automatically with <span class="kbd">localStorage</span>. Switch months using the tabs above.</div>
          </div>
        </div>
      </section>

      <aside class="card">
        <h2>How it works ✨</h2>
        <ol class="mut">
          <li>Add all income lines (salary, side gigs).
          <li>Enter your credit card statement. If you pick <em>minimum</em>, we reserve that amount now and show the carried balance.
          <li>List your fixed and variable expenses.
          <li>Choose savings by % or fixed.
          <li>Read the summary: leftover and safe-per-day.
        </ol>
        <details style="margin-top:8px">
          <summary><strong>Carry-over note</strong></summary>
          <p class="mut">If you pay minimum, the unpaid part is shown as “carried”. This app doesn’t calculate bank interest; it simply helps you plan cash flow. Aim to switch back to “Pay in full” ASAP.</p>
        </details>
        <details style="margin-top:8px">
          <summary><strong>Shortcuts</strong></summary>
          <ul class="mut">
            <li><span class="kbd">Tab</span> to move fields, <span class="kbd">Shift</span> + <span class="kbd">Tab</span> to go back.
            <li>Press <span class="kbd">Enter</span> inside an amount to update totals.
          </ul>
        </details>
        <details style="margin-top:8px">
          <summary><strong>Appearance & Background</strong> 🌈</summary>
          <div class="mut" style="margin-top:8px">
            <label>Theme
              <select id="themeSelect">
                <option value="candy">Candy Sky (default)</option>
                <option value="money">Money Rain</option>
                <option value="galaxy">Galaxy Glow</option>
              </select>
            </label>
            <div style="margin-top:8px" class="flex">
              <label class="pill"><input type="checkbox" id="toggleAnim" checked> &nbsp;Animated background</label>
              <label class="pill"><input type="checkbox" id="syncName" checked> &nbsp;Auto-fill name from category</label>
              <label class="pill"><input type="checkbox" id="toggleConfetti" checked> &nbsp;Confetti on positive leftover</label>
            </div>
          </div>
        </details>
        <details style="margin-top:8px">
          <summary><strong>Expense Categories</strong> 🧸</summary>
          <div class="mut" style="margin-top:8px">
            <div id="catChips" class="flex" style="flex-wrap:wrap"></div>
            <div class="footer-actions">
              <button class="btn" id="btnAddCat">+ Add category</button>
              <button class="btn" id="btnResetCat">Reset to defaults</button>
            </div>
            <p class="note">Categories power the dropdowns in Fixed & Variable lists. You can still type custom names anytime.</p>
          </div>
        </details>
      </aside>
    </div>
  </div>

<script>
(function(){
  const $ = (q, el=document)=>el.querySelector(q);
  const $$ = (q, el=document)=>Array.from(el.querySelectorAll(q));

  // --- State ---
  const storeKey = 'mymoney.v2';
  const now = new Date();
  const ym = (d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
  let activeMonth = ym(now);

  const defaultCategories = [
    'Rent/Mortgage','Utilities','Internet','Phone','Insurance','Loans','Subscriptions',
    'Groceries','Transport','Dining Out','Entertainment','Shopping','Health','Education','Gifts','Travel','Pets','Misc'
  ];

  const blankMonth = ()=>({
    income:[{name:'Salary', amount:0}],
    cc:{amount:0, mode:'full', minPct:5},
    fixed:[{cat:'Rent/Mortgage', name:'Rent', amount:0}],
    variable:[{cat:'Groceries', name:'Groceries', amount:0}],
    saving:{mode:'percent', pct:10, amount:0}
  });

  const state = load() || { months: { [activeMonth]: blankMonth() }, categories: defaultCategories.slice(), settings:{theme:'candy', anim:true, syncName:true, confetti:true} };
  if(!state.months[activeMonth]) state.months[activeMonth] = blankMonth();

  // Apply theme immediately
  applyTheme();

  // --- UI Builders ---
  const monthTabs = $('#monthTabs');
  const incomeList = $('#incomeList');
  const fixedList = $('#fixedList');
  const varList = $('#varList');

  function buildTabs(){
    monthTabs.innerHTML = '';
    const months = Object.keys(state.months).sort();
    months.forEach(m=>{
      const btn = document.createElement('button');
      btn.className = 'tab' + (m===activeMonth?' active':'');
      btn.textContent = labelMonth(m);
      btn.onclick = ()=>{ activeMonth = m; renderAll(); save(); };
      monthTabs.appendChild(btn);
    });
    const addBtn = document.createElement('button');
    addBtn.className = 'tab'; addBtn.textContent = '+ Add Month';
    addBtn.onclick = ()=>{
      const next = prompt('Create month YYYY-MM (e.g. 2025-10)', activeMonth);
      if(!next) return; if(!/^\d{4}-\d{2}$/.test(next)) return alert('Use YYYY-MM');
      if(!state.months[next]) state.months[next]=blankMonth();
      activeMonth = next; renderAll(); save();
    };
    monthTabs.appendChild(addBtn);
  }

  function labelMonth(m){
    const [y,mo] = m.split('-').map(Number);
    const d = new Date(y, mo-1, 1);
    return d.toLocaleString(undefined,{month:'short', year:'numeric'});
  }

  function optionsHtml(){
    return state.categories.map(c=>`<option>${escapeHtml(c)}</option>`).join('');
  }

  function makeLine(listEl, arr, onChange, withCat=false){
    listEl.innerHTML = '';
    arr.forEach((row, idx)=>{
      const line = document.createElement('div');
      line.className = 'item';
      line.innerHTML = `
        ${withCat?`<select aria-label="category">${optionsHtml()}<option value="__custom">Custom…</option></select>`:''}
        <input type="text" value="${escapeHtml(row.name||'')}" placeholder="Name" aria-label="name">
        <input type="number" value="${row.amount||0}" min="0" step="0.01" aria-label="amount">
        <button class="del" title="Delete">✕</button>
      `;
      let catEl=null; let nameEl=null; let amtEl=null; let delEl=null;
      if(withCat){ [catEl, nameEl, amtEl, delEl] = line.children; } else { [nameEl, amtEl, delEl] = line.children; }

      if(withCat){
        // initialize category select from row.cat if present
        const initial = row.cat && state.categories.includes(row.cat) ? row.cat : (state.categories[0]||'Misc');
        catEl.value = row.cat || initial;
        catEl.onchange = ()=>{
          if(catEl.value==='__custom'){
            const val = prompt('Type your custom category name');
            if(val){
              row.cat = val;
              if(state.settings.syncName || !nameEl.value){ nameEl.value = val; row.name = val; }
            }else{
              catEl.value = initial; row.cat = initial;
            }
          } else {
            row.cat = catEl.value;
            if(state.settings.syncName || !nameEl.value){ nameEl.value = row.cat; row.name = row.cat; }
          }
          onChange();
        };
      }

      nameEl.oninput = ()=>{ row.name = nameEl.value; onChange(); };
      amtEl.oninput = ()=>{ row.amount = parseFloat(amtEl.value||0); onChange(); };
      amtEl.onchange = onChange;
      delEl.onclick = ()=>{ arr.splice(idx,1); onChange(); };
      listEl.appendChild(line);
    });
  }

  // --- Render / Compute ---
  const el = {
    ccAmount: $('#ccAmount'), ccMinPct: $('#ccMinPct'),
    sumIncome: $('#sumIncome'), sumCC: $('#sumCC'), sumFixed: $('#sumFixed'), sumVar: $('#sumVar'), sumSave: $('#sumSave'), sumLeft: $('#sumLeft'), perDay: $('#perDay'), daysLeft: $('#daysLeft'),
    overspendRow: $('#overspendRow'), perDayRow: $('#perDayRow'), minReserve: $('#minReserve'),
    themeSelect: $('#themeSelect'), toggleAnim: $('#toggleAnim'), syncName: $('#syncName'), confetti: $('#toggleConfetti'), catChips: $('#catChips')
  };

  function readActive(){ return state.months[activeMonth]; }

  function calc(){
    const m = readActive();
    const income = sum(m.income);
    const ccAmt = +el.ccAmount.value || 0;
    const payMode = $('input[name="ccPay"]:checked').value;
    const minPct = +el.ccMinPct.value || 5;
    const ccPay = payMode==='full' ? ccAmt : ccAmt * (minPct/100);
    const ccCarry = Math.max(0, ccAmt - ccPay);

    const fixed = sum(m.fixed);
    const variable = sum(m.variable);

    let saveAmt = 0;
    const saveMode = $('input[name="saveMode"]:checked').value;
    if(saveMode==='percent') saveAmt = income * ((+$('#savePct').value||0)/100);
    else saveAmt = +$('#saveAmt').value||0;

    const left = income - ccPay - fixed - variable - saveAmt;

    // Days left in month for per-day safe amount
    const [yy,mm] = activeMonth.split('-').map(Number);
    const today = new Date();
    const inMonth = today.getFullYear()===yy && today.getMonth()===(mm-1);
    const totalDays = new Date(yy, mm, 0).getDate();
    const dayStart = inMonth ? today.getDate() : 1;
    const remainingDays = totalDays - dayStart + 1;

    return { income, ccAmt, ccPay, ccCarry, fixed, variable, saveAmt, left, remainingDays };
  }

  function fmt(n){ return (n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }
  function sum(arr){ return arr.reduce((a,b)=>a + (+b.amount||0), 0); }

  function renderAll(){
    buildTabs();
    const m = readActive();

    // Rebuild lists
    makeLine(incomeList, m.income, onChange, false);
    makeLine(fixedList, m.fixed, onChange, true);
    makeLine(varList, m.variable, onChange, true);

    // Set inputs
    el.ccAmount.value = m.cc.amount || 0;
    el.ccMinPct.value = m.cc.minPct || 5;
    $$('input[name="ccPay"]').forEach(r=>{ r.checked = (r.value===m.cc.mode) });
    $$('input[name="saveMode"]').forEach(r=>{ r.checked = (r.value===m.saving.mode) });
    $('#savePct').value = m.saving.pct || 10;
    $('#saveAmt').value = m.saving.amount || 0;

    // Theme controls
    el.themeSelect.value = state.settings.theme || 'candy';
    el.toggleAnim.checked = !!state.settings.anim;
    el.syncName.checked = state.settings.syncName !== false;
    el.confetti.checked = state.settings.confetti !== false;
    $('.bg-layer').classList.toggle('off', !state.settings.anim);

    renderCats();
    updateSummary();
  }

  function renderCats(){
    el.catChips.innerHTML = '';
    state.categories.forEach((c,i)=>{
      const chip = document.createElement('button');
      chip.className = 'btn';
      chip.textContent = c;
      chip.title = 'Click to remove';
      chip.onclick = ()=>{ if(confirm(`Remove category "${c}"?`)){ state.categories.splice(i,1); renderAll(); save(); } };
      el.catChips.appendChild(chip);
    });
  }

  function updateSummary(){
    const m = readActive();
    const c = calc();

    el.sumIncome.textContent = `RM ${fmt(c.income)}`;
    const payMode = $('input[name="ccPay"]:checked').value;
    el.sumCC.textContent = payMode==='full' ? `RM ${fmt(c.ccAmt)} (full)` : `RM ${fmt(c.ccPay)} (min), carry RM ${fmt(c.ccCarry)}`;
    el.minReserve.textContent = `RM ${fmt(c.ccPay)}`;

    el.sumFixed.textContent = `RM ${fmt(c.fixed)}`;
    el.sumVar.textContent = `RM ${fmt(c.variable)}`;
    el.sumSave.textContent = `RM ${fmt(c.saveAmt)}`;
    el.sumLeft.textContent = `RM ${fmt(c.left)}`;

    const perDay = c.left>0 ? c.left/Math.max(1, c.remainingDays) : 0;
    el.perDay.textContent = `RM ${fmt(perDay)}`;
    el.daysLeft.textContent = c.remainingDays;

    el.overspendRow.style.display = c.left < 0 ? '' : 'none';

    // Persist snapshot
    m.cc.amount = +el.ccAmount.value || 0;
    m.cc.mode = $('input[name="ccPay"]:checked').value;
    m.cc.minPct = +el.ccMinPct.value || 5;
    m.saving.mode = $('input[name="saveMode"]:checked').value;
    m.saving.pct = +$('#savePct').value || 0;
    m.saving.amount = +$('#saveAmt').value || 0;
    save();

    // Mascot bounce when positive left
    if(c.left>0){ bounceMascot(); if(state.settings.confetti){ confettiBurst(); } }
  }

  // --- Events ---
  function onChange(){ updateSummary(); }

  $('#addIncome').onclick = ()=>{ readActive().income.push({name:'Income', amount:0}); renderAll(); };
  $('#addFixed').onclick = ()=>{ readActive().fixed.push({cat:state.categories[0]||'Misc', name:state.categories[0]||'Item', amount:0}); renderAll(); };
  $('#addVar').onclick = ()=>{ readActive().variable.push({cat:state.categories[7]||'Groceries', name:state.categories[7]||'Groceries', amount:0}); renderAll(); };

  ['ccAmount','ccMinPct','savePct','saveAmt'].forEach(id=>{
    const e = document.getElementById(id); e.addEventListener('input', updateSummary); e.addEventListener('change', updateSummary);
  });
  $$('input[name="ccPay"]').forEach(r=> r.onchange = updateSummary);
  $$('input[name="saveMode"]').forEach(r=> r.onchange = updateSummary);

  $('#btnQuickAdd').onclick = ()=>{ renderAll(); };

  $('#btnToday').onclick = ()=>{
    activeMonth = ym(new Date());
    if(!state.months[activeMonth]) state.months[activeMonth] = blankMonth();
    renderAll(); save();
  };

  $('#btnReset').onclick = ()=>{
    if(confirm('Clear all lines for this month?')){
      state.months[activeMonth] = blankMonth();
      renderAll(); save();
    }
  };

  $('#btnExport').onclick = ()=>{
    const data = JSON.stringify(state, null, 2);
    const blob = new Blob([data], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `my-money-${activeMonth}.json`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  };
  $('#importFile').onchange = (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const obj = JSON.parse(reader.result);
        if(!obj.months) throw new Error('Invalid file');
        Object.assign(state, obj);
        if(!state.categories) state.categories = defaultCategories.slice();
        if(!state.settings) state.settings = {theme:'candy', anim:true};
        if(!state.months[activeMonth]) activeMonth = Object.keys(state.months)[0];
        applyTheme();
        renderAll(); save();
      }catch(err){ alert('Import failed: '+err.message); }
    };
    reader.readAsText(file);
  };

  // Category controls
  $('#btnAddCat').onclick = ()=>{
    const val = prompt('New category name');
    if(val){ state.categories.push(val); renderAll(); save(); }
  };
  $('#btnResetCat').onclick = ()=>{
    if(confirm('Reset categories to defaults?')){ state.categories = defaultCategories.slice(); renderAll(); save(); }
  };

  // Theme controls
  el.themeSelect.onchange = ()=>{ state.settings.theme = el.themeSelect.value; applyTheme(); save(); };
  el.toggleAnim.onchange = ()=>{ state.settings.anim = el.toggleAnim.checked; document.querySelector('.bg-layer').classList.toggle('off', !state.settings.anim); save(); };
  el.syncName.onchange = ()=>{ state.settings.syncName = el.syncName.checked; save(); };
  el.confetti.onchange = ()=>{ state.settings.confetti = el.confetti.checked; save(); };

  function applyTheme(){ document.body.setAttribute('data-theme', (state.settings&&state.settings.theme)||'candy'); }

  // Mascot bounce (subtle)
  function confettiBurst(){
    const n = 14;
    for(let i=0;i<n;i++){
      const s = document.createElement('div');
      s.textContent = ['💸','🪙','✨','💖'][i%4];
      Object.assign(s.style,{position:'fixed', left:(50+Math.random()*20-10)+'vw', top:'10vh', fontSize:(16+Math.random()*14)+'px', zIndex:9999, pointerEvents:'none'});
      document.body.appendChild(s);
      s.animate([
        {transform:'translate(0,0) rotate(0deg)', opacity:1},
        {transform:`translate(${(Math.random()*2-1)*120}px, ${80+Math.random()*200}px) rotate(${(Math.random()*2-1)*140}deg)`, opacity:0}
      ], {duration:900+Math.random()*500, easing:'cubic-bezier(.2,.6,.2,1)'}).onfinish=()=>s.remove();
    }
  }
  function bounceMascot(){ const logo = document.querySelector('.logo'); if(!logo) return; logo.animate([{transform:'translateY(0)'},{transform:'translateY(-6px)'},{transform:'translateY(0)'}],{duration:500}); }

  // Storage
  function save(){ try{ localStorage.setItem(storeKey, JSON.stringify(state)); }catch(e){} }
  function load(){ try{ return JSON.parse(localStorage.getItem(storeKey)||''); }catch(e){ return null; } }

  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",
    ">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

  // Initial render
  renderAll();
})();
</script>
</body>
</html>
